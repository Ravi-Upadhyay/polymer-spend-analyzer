<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="bar-chart-component.html">

<dom-module id="payment-analyser">
    <template>
        <style include="shared-styles">
            :host{
                font-family: Arial, Helvetica, sans-serif;
                font-size: 26px;
            }
            	
            h4{
                text-align:center;
            }
            #analyser_grid{
                width: 55%;
                margin: 0 auto;
            }            
            .amcharts-chart-div a{
                display: none !important;
            }     
            
        </style>
        <iron-ajax id="analyser" handle-as="json" last-response="{{activities}}" on-response="_handleResponse"></iron-ajax>

        <h4> Account Activity Analysis </h4>

        <vaadin-grid id="analyser_grid" theme="row-dividers" items="[[activities]]" page-size="10" height-by-rows column-reordering-allowed>
            <vaadin-grid-column width="9em" items="[[activities]]">
                <template class="header">#</template>
                <template>[[displayIndex(index)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="9em">
                <template class="header">Month</template>
                <template>[[item.month]]</template>
            </vaadin-grid-column>

            <vaadin-grid-column width="9em">
                <template class="header">Total Transaction</template>
                <template>[[addCurrency(item.totalTransaction)]]</template>
            </vaadin-grid-column>
    
            <vaadin-grid-column width="9em">
                <template class="header">Debit</template>
                <template>[[addCurrency(item.debit)]]</template>
            </vaadin-grid-column>
    
            <vaadin-grid-column width="9em">
                <template class="header">Credit</template>
                <template>[[addCurrency(item.credit)]]</template>
            </vaadin-grid-column>            
        </vaadin-grid>     

        <h4>Spend Analyser</h4>
        <barchart-component transactions=[[transactions]]></barchart-component>
        
    </template>
    <script>
        class paymentAnalyser extends Polymer.Element{

            static get is(){ return 'payment-analyser'}
            static get properties(){
                return  {
                   spendChart : {},
                   transactions: {
                       type:Array,
                   }
                }
            }
            
            ready(){
                super.ready();
                Polymer.RenderStatus.afterNextRender(this,function(){
                    this._getTransactionData();                    
                })
            }
            
            //Increment by 1 to index in dom-repeat
            displayIndex(index){
                return index + 1;
            }            

            // Add currency
            addCurrency(amount){
                return '$' + amount;
            }

            //Get transaction data ffrom API
            _getTransactionData(){
                var ajax = this.$.analyser;
                ajax.url = "src/data/analyser.json";
                ajax.generateRequest(); //trigger the iron-ajax                
            }

            //Store the response 
            _handleResponse(event,request){
                this.transactions = request.response;
                console.log(this.transactions);
                this.transactionsLoaded = true;
                 //this.configureChart(this.transactions);
                //this._generateChart(this.transactions);
            }

            // Generate chart from transaction data
            _generateChart(data){                
                var Chart = this.$.chartdiv;                 
                this.spendChart = AmCharts.makeChart(Chart, {
                    "theme": "light", 
                    "type": "serial",
                    //"fontSize" : 14,
                    "dataProvider":data,
                    "valueAxes": [{
                        "stackType": "3d",
                        "unit": "",
                        "position": "left",
                        "title": "",
                        "autoGridCount" :false
                    }],
                    // set startDuration to 0 on older browsers
                    "startDuration": this._supportSVG()? 1 : 0,                                 
                    "depth3D": 60,
                    "angle": 30,
                    "categoryField": "month",                    
                    "graphs": [{
                        "balloonText": "Credit in [[category]]: <b>[[value]]</b>",
                        "fillAlphas": 0.9,                       
                        "title": "Credit",
                        "type": "column",
                        "fixedColumnWidth": 50,//adjusts with of the column
                        //"colorField": "Ccolor", //change color
                        "valueField": "credit"
                    }, {
                        "balloonText": "Debit in [[category]]: <b>[[value]]</b>",
                        "fillAlphas": 0.9,                       
                        "title": "Debit",
                        "type": "column",
                        //"colorField": "Dcolor",//change color
                        "fixedColumnWidth": 50,
                        "valueField": "debit"
                    }]                     
                });                
            }
            // Check for SVG support in old browser
            _supportSVG(){
                return !!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', "svg").createSVGRect;
            }
        };
        window.customElements.define(paymentAnalyser.is,paymentAnalyser);
    </script>
</dom-module>