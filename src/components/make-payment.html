<!-- 
** PAYMENT COMPONENT
* This will be a component to make payment through debit or credit type.
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<script src="../../bower_components/web-animations-js/web-animations.min.js"></script>
<link rel="import" href="common-styles.html">
<dom-module id="make-payment">
    <template>
        <style include="common-styles">
         :host {
            height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

         :root {
            --paper-input-container: {
                position: relative;
            }
            ;

            --paper-input-error: {
                position: absolute;
                width: 100%;
            }
        }

        .container {
            width: 33.33%;
            border-radius: 10px;
            -webkit-box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 0.75);
            -moz-box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 0.75);
            box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 0.75);
            margin: 0 auto;
            margin-top: 50px;
            background-color: #ffffff;
            padding: 25px;
        }

        .floated-label-placeholder {
            color: #000 !important;
            font-weight: bold !important;
        }

        .vertical-section-container {
            max-width: 500px;
        }

        paper-dropdown-menu,
        paper-button,
        paper-item,
        paper-input {
            width: 100%;
            margin-right: 20px;
            padding-bottom: 15px;
        }

        paper-button {
            padding: 10px;
            margin: 0 auto;
            margin-top: 20px;
        }

        paper-dropdown-menu paper-item {
            --paper-item-selected-weight: 700;
            --paper-item-focused-before: {
                background: #fff;
            }
            ;
        }

        paper-item {
            cursor: pointer;
        }

        paper-button {
            color: #fff;
            background-color: #42417A;
            width: 200px;
            border-radius: 10px;
            margin-top: 25px;
            margin-left: 25%;
        }

        paper-button[disabled] {
            background-color: grey
        }


        hr {
            width: 100%;
            height: 5px;
            background-color: #FF6600;

        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
        </style>
        <div class="container">
            <h2>Make Payment</h2>
            <hr size="30">

            <!-- localstorage compoment to store the transaction details -->
            <iron-localstorage name="transactionDetails" value="{{transactionDetails}}" on-iron-localstorage-load-empty="initializeStorage"></iron-localstorage>

            <!-- Ajax component to make a post request to payment API -->
            <iron-ajax id="transaction" method="post" content-type="application/json" handle-as="json" on-response="_handleResponse" loading="{{loading}}"></iron-ajax>
            <paper-spinner-lite active="[[loading]]"></paper-spinner-lite>
            
            <!-- Dropdown component  -->
            <paper-dropdown-menu id="type" label="Select transaction type" always-float-label>
                <paper-listbox slot="dropdown-content" attr-for-selected="value" class="dropdown-content" selected="{{selectedType}}">
                    <template is="dom-repeat" items="[[transactionType]]">
                        <paper-item value$="[[item.type]]">[[item.type]]</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>

            <paper-input on-keyup="_clearError"  label="Enter amount" id="amount" type="number" always-float-label error-message="{{amountError}}" value="{{amount}}">
                <div slot="prefix">$ &nbsp</div>
            </paper-input>

            <paper-input label="Enter description" id="description" always-float-label error-message="{{amountError}}" value="{{description}}">
                <div></div>
            </paper-input>

            <app-location route="{{route}}"></app-location>
            <paper-button disabled="[[isInputEmpty(amount)]]" nolink on-click="_makeTransaction">
                Make Payment
            </paper-button>
        </div>
    </template>
    <script>
    class makePayment extends Polymer.Element {
        static get is() { return 'make-payment' }
        static get properties() {
            return {
                transactionType: {
                    type: Array,
                    value: [{
                        type: 'Debit',
                        value: 0
                    }, {
                        type: 'Credit',
                        value: 1,
                    }]
                },
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                description: {
                    type: String,
                    value: ''
                },
                selectedType: {
                    type: String,
                    value: 'Debit' //Set debit as default
                },
                transactionDetails: {
                    type: Array,
                    value: () => { return [] }
                }
            }
        }


        //Initialize localstorage
        initializeStorage() {
            this.transactionDetails = [];
        }

        _clearError() {
            this.$.amount.invalid = false; //remove error message
        }

        _makeTransaction() {
            this.transactionDetails = [];
         this.set("route.path", "/status")
            var amount = this.amount
            var paymentType = this.selectedType
            var description = this.description
            var ajax = this.$.transaction;
            ajax.url = 'http://192.168.43.120:8080/user/1000/makepayment';
            ajax.body = JSON.stringify({
                "customerId": "1000",
                "amount": amount,
                "paymentType": paymentType,
                "description": description
            });
            ajax.generateRequest(); // triggers the iron-ajax
        }

        isInputEmpty(amount) {
            if (amount<= 0) return true;
            return false;
        }

        _handleResponse(response) {
            console.log('response', response.detail.__data.response.data);
            var data = response.detail.__data.response.data;
            //spot data
            if (data.status) {
                this.transactionDetails.push(data.data)
                //Take care of routing
                 this.set("route.path", "/status");
                  window.location.hash="no-back-button";
           window.location.hash="Again-No-back-button";
           window.onhashchange=function(){window.location.hash="no-back-button";}
                
            } else {
                //Set error message
                this.amountError = data.errorMessage
                this.$.amount.invalid = true; //show message error

            }
        }
    }
    window.customElements.define(makePayment.is, makePayment);
    </script>
</dom-module>